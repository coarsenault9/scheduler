<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Scheduler App</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.css">
<style>
  body { font-family: Arial, sans-serif; margin: 18px; }
  nav { margin-bottom: 12px; }
  nav button { margin-right: 8px; }
  .page { display: none; }
  .page.active { display: block; }
  .palette { display:flex; gap:6px; flex-wrap:wrap; margin:8px 0; }
  .swatch { width:22px; height:22px; border:1px solid #999; border-radius:4px; cursor:pointer; }
  .swatch.clear { display:flex; align-items:center; justify-content:center; font-size:14px; }
  .handsontable th { background:#eee !important; }
  td.day-sep { border-right: 1px solid #aaa !important; }
  table.out { border-collapse: collapse; width:100%; margin-top:10px; }
  table.out th, table.out td { border:1px solid #ccc; padding:6px; font-size:12px; }
  table.out th { background:#eee; }
</style>
</head>
<body>
  <h1>Scheduler App</h1>
  <nav>
    <button onclick="showPage('schedulerPage')">Scheduler</button>
    <button onclick="showPage('directoryPage')">Directory</button>
    <button onclick="showPage('reportsPage')">Reports</button>
  </nav>

  <!-- Scheduler Page -->
  <div id="schedulerPage" class="page active">
    <h2>Monthly Scheduler</h2>
    <div class="toolbar">
      <button onclick="prevMonth()">◀ Prev</button>
      <span id="monthLabel"></span>
      <button onclick="nextMonth()">Next ▶</button>
      <span style="margin-left:12px;"><b>Fill color:</b></span>
      <div class="palette" id="palette"></div>
      <span style="margin-left:12px;"><b>Rows:</b></span>
      <input id="rowsToModify" type="number" min="1" value="1" style="width:60px;">
      <button onclick="addRows()">+ Add</button>
      <button onclick="delRows()">– Delete</button>
    </div>
    <div id="grid"></div>
  </div>

  <!-- Directory Page -->
  <div id="directoryPage" class="page">
    <h2>Email Directory</h2>
    <div id="directory"></div>
  </div>

  <!-- Reports Page -->
  <div id="reportsPage" class="page">
    <h2>Reports</h2>
    <label>Choose Month: 
      <select id="monthSelect"></select>
    </label>
    <button onclick="renderReports()">Generate Report</button>
    <h3>ShiftLog</h3>
    <div id="shiftLog"></div>
    <h3>Employee Summary</h3>
    <div id="summary"></div>
    <h3>Study Visits</h3>
    <div id="summaryStudy"></div>
    <h3>Site Visits</h3>
    <div id="summarySite"></div>
  </div>

<!-- ========= Everything below runs as ONE ESM module (CSP-friendly) ========= -->
<script type="module">
/* ---------------- Imports (ESM) ---------------- */
import Handsontable from "https://cdn.jsdelivr.net/npm/handsontable@14.3.0/esm/handsontable.js";
import { registerAllModules } from "https://cdn.jsdelivr.net/npm/handsontable@14.3.0/esm/registry.mjs";
registerAllModules(); // IMPORTANT for contextMenu + plugins

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ---------------- Firebase Init ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCfwfn-7WFnKNv-rdomdHxWU11WMIk7-NQ",
  authDomain: "crcscheduler.firebaseapp.com",
  projectId: "crcscheduler",
  storageBucket: "crcscheduler.firebasestorage.app",
  messagingSenderId: "865356677041",
  appId: "1:865356677041:web:002d88c85f00140088c790",
  measurementId: "G-00XV2C5HDL"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Anonymous auth
signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth, (u) => {
  if (u) console.log("Firebase signed in (anon):", u.uid);
});

/* ---------------- Shared State (your original) ---------------- */
let monthStore={}, current=new Date(), hot, directoryHot;
let lastSel=null, clipboardMeta=null;
const COLS_PER_DAY=2, DAYS_PER_WEEK=7, TOTAL_COLS=DAYS_PER_WEEK*COLS_PER_DAY;
let bodyRows=[];
let unsubscribeMonth = null;

/* ---------------- Firestore helpers (flatten to avoid nested arrays) ---------------- */
function toRowMap(data){
  const obj={};
  for(let i=0;i<data.length;i++){
    obj[i] = data[i].map(v => (v==null ? "" : String(v)));
  }
  return obj;
}
function fromRowMap(obj){
  if(!obj) return [];
  const keys = Object.keys(obj).map(Number).sort((a,b)=>a-b);
  return keys.map(k => (obj[k]||[]).map(v => (v===""? "" : v)));
}
function serializeReports(state){
  const toShiftObjs = (rows)=> rows.map(r=>({
    date:r[0]||"", study:r[1]||"", visit:r[2]||"", role:r[3]||"",
    employee:r[4]||"", email:r[5]||"", site:r[6]||"", pi:r[7]||""
  }));
  const toKV = (rows)=> rows.map(r=>({ k:r[0]||"", v:r[1]||0 }));
  return {
    shiftLog: toShiftObjs(state.shiftLog||[]),
    summary: toKV(state.summary||[]),
    summaryStudy: toKV(state.summaryStudy||[]),
    summarySite: toKV(state.summarySite||[])
  };
}
function deserializeReports(docData){
  const fromShiftObjs = (arr)=> (arr||[]).map(o=>[
    o.date||"", o.study||"", o.visit||"", o.role||"", o.employee||"", o.email||"", o.site||"", o.pi||""
  ]);
  const fromKV = (arr)=> (arr||[]).map(o=>[o.k||"", o.v||0]);
  return {
    shiftLog: fromShiftObjs(docData.shiftLog),
    summary: fromKV(docData.summary),
    summaryStudy: fromKV(docData.summaryStudy),
    summarySite: fromKV(docData.summarySite)
  };
}

/* ---------------- Page Switching ---------------- */
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='reportsPage') refreshMonthSelect();
}

/* ---------------- Calendar Helpers ---------------- */
function monthKey(y,m){ return `${y}-${String(m+1).padStart(2,'0')}`; }
function startOfCalendar(year, monthIdx){
  const first=new Date(year,monthIdx,1);
  const dow=(first.getDay()+6)%7; // Mon=0
  const d=new Date(first);
  d.setDate(first.getDate()-dow);
  return d;
}
function numWeeks(year, monthIdx){
  const start=startOfCalendar(year,monthIdx);
  const end=new Date(year,monthIdx+1,0);
  const diff=Math.ceil((end-start)/86400000)+1;
  return Math.ceil(diff/7);
}
function buildWeekMatrix(year, monthIdx, weeks){
  const start=startOfCalendar(year,monthIdx);
  const matrix=[];
  for(let w=0;w<weeks;w++){
    const row=[];
    for(let d=0;d<DAYS_PER_WEEK;d++){
      const cell=new Date(start);
      cell.setDate(start.getDate()+w*7+d);
      row.push({ date: new Date(cell), inMonth: cell.getMonth()===monthIdx });
    }
    matrix.push(row);
  }
  return matrix;
}

/* ---------------- Data ---------------- */
function buildDataFor(y,m,weeks,br){
  const rows=br.reduce((s,b)=>s+1+b,0);
  return Array.from({length:rows},()=>Array(TOTAL_COLS).fill(""));
}

/* ---------------- Renderer ---------------- */
function colorRenderer(instance, td, row, col, prop, value, cellProps){
  Handsontable.renderers.TextRenderer.apply(this, arguments);

  const key=monthKey(current.getFullYear(),current.getMonth());
  const color=monthStore[key]?.meta?.[`${row}:${col}`];
  if(color) td.style.background=color;

  // Grey-out days not in month
  const state = monthStore[key];
  if (state && state.calendar) {
    const weekIdx = weekIndexForRow(row);
    const dayIdx = Math.floor(col / 2);
    if (weekIdx >= 0 && state.calendar[weekIdx] && !state.calendar[weekIdx][dayIdx].inMonth) {
      td.style.background = "#f0f0f0";
      td.style.color = "#999";
    }
  }

  if(weekStarts().includes(row)){
    td.style.background="#e0e0e0";
    td.style.fontWeight="600";
  }
  if(col%2===1) td.classList.add('day-sep');
}

/* ---------------- Scheduler ---------------- */
function weekStarts(){let starts=[],acc=0;for(let i=0;i<bodyRows.length;i++){starts.push(acc);acc+=1+bodyRows[i];}return starts;}
function weekIndexForRow(rowIdx){const starts=weekStarts();for(let i=0;i<bodyRows.length;i++){if(rowIdx>=starts[i]&&rowIdx<=starts[i]+bodyRows[i])return i;}return -1;}

function renderMonth(){
  const y=current.getFullYear(), m=current.getMonth(), key=monthKey(y,m);
  const weeks=numWeeks(y,m);

  // Attach Firestore listener first (will overwrite local when data exists)
  attachMonthListener(key);

  // Always seed local view so you SEE a calendar immediately
  if(!monthStore[key]){
    const br=Array(weeks).fill(8);
    const data=buildDataFor(y,m,weeks,br);
    const matrix=buildWeekMatrix(y,m,weeks);
    const dayMeta={};
    let acc=0;
    for(let w=0;w<weeks;w++){
      for(let d=0;d<DAYS_PER_WEEK;d++){
        const c=d*COLS_PER_DAY;
        data[acc][c]=matrix[w][d].date.toLocaleString('default',{weekday:'short'})+" "+matrix[w][d].date.getDate();
        dayMeta[`${acc}:${c}`]=matrix[w][d];
      }
      acc+=1+br[w];
    }
    monthStore[key]={data,bodyRows:br,meta:{},dayMeta,calendar:matrix,shiftLog:[],summary:[],summaryStudy:[],summarySite:[]};
    // Create the doc if it doesn't exist yet
    saveMonth(key);
  }else{
    monthStore[key].calendar = buildWeekMatrix(y,m,weeks);
  }

  bodyRows=monthStore[key].bodyRows.slice();
  document.getElementById("monthLabel").textContent=current.toLocaleString('default',{month:'long'})+" "+y;

  if(hot) hot.destroy();
  hot=new Handsontable(document.getElementById('grid'),{
    data:monthStore[key].data,
    colHeaders:false,
    rowHeaders:true,
    columns:Array.from({length:TOTAL_COLS},()=>({type:'text'})),
    licenseKey:'non-commercial-and-evaluation',
    contextMenu:true,
    cells:(r,c)=>{let props={renderer:colorRenderer}; if(weekStarts().includes(r)) props.readOnly=true; return props;},
    afterSelectionEnd:(r1,c1,r2,c2)=>{lastSel=[r1,c1,r2,c2];},
    afterCopy:(data,coords)=>{clipboardMeta=[];coords.forEach(({startRow,startCol,endRow,endCol})=>{
      for(let r=startRow;r<=endRow;r++)for(let c=startCol;c<=endCol;c++){
        const key=monthKey(current.getFullYear(),current.getMonth());
        const color=monthStore[key]?.meta?.[`${r}:${c}`]||null;
        clipboardMeta.push({r:r-startRow,c:c-startCol,color});
      }});},
    afterPaste:(data,coords)=>{if(!clipboardMeta)return;const {startRow,startCol}=coords[0];const key=monthKey(current.getFullYear(),current.getMonth());
      clipboardMeta.forEach(item=>{if(item.color){const rr=startRow+item.r,cc=startCol+item.c;monthStore[key].meta[`${rr}:${cc}`]=item.color;}});
      hot.render(); saveMonth(key);},
    afterChange:(changes, source)=>{ if(source!=='loadData'){ const key=monthKey(current.getFullYear(),current.getMonth()); saveMonth(key);} }
  });

  // Directory table (init once)
  if(!directoryHot){
    directoryHot=new Handsontable(document.getElementById('directory'),{
      data:[["","",""]],
      colHeaders:["Name","Email","Phone"], rowHeaders:true, minSpareRows:1,
      contextMenu:true, licenseKey:'non-commercial-and-evaluation'
    });
  }
}
function prevMonth(){ current.setMonth(current.getMonth()-1); renderMonth(); }
function nextMonth(){ current.setMonth(current.getMonth()+1); renderMonth(); }

/* ---------------- Colors ---------------- */
const colors=["#f28b82","#fbbc04","#fff475","#ccff90","#a7ffeb","#cbf0f8","#aecbfa","#d7aefb","#fdcfe8","#e6c9a8","#e8eaed","#d50000","#c51162","#aa00ff","#304ffe","#2962ff","#0091ea","#00b8d4","#00c853","#64dd17"];
function applyColor(color){
  const sel=lastSel||hot.getSelectedLast(); if(!sel)return;
  const [r1,c1,r2,c2]=sel; const key=monthKey(current.getFullYear(),current.getMonth());
  if(!monthStore[key].meta) monthStore[key].meta={};
  for(let r=Math.min(r1,r2);r<=Math.max(r1,r2);r++){ if(weekStarts().includes(r))continue;
    for(let c=Math.min(c1,c2);c<=Math.max(c1,c2);c++){
      if(color) monthStore[key].meta[`${r}:${c}`]=color; else delete monthStore[key].meta[`${r}:${c}`];
    }}
  hot.render(); saveMonth(key);
}
// Build palette UI
(function(){const p=document.getElementById('palette');colors.forEach(c=>{let sw=document.createElement('div');sw.className='swatch';sw.style.background=c;sw.onclick=()=>applyColor(c);p.appendChild(sw);});let clr=document.createElement('div');clr.className='swatch clear';clr.textContent='×';clr.title='Clear color';clr.onclick=()=>applyColor(null);p.appendChild(clr);})();

/* ---------------- Add/Delete Rows ---------------- */
function shiftMeta(meta, startRow, delta){
  const newMeta={};
  Object.entries(meta).forEach(([k,v])=>{
    let [r,c]=k.split(":").map(Number);
    if(r>=startRow) r+=delta;
    newMeta[`${r}:${c}`]=v;
  });
  return newMeta;
}
function addRows(){const n=parseInt(document.getElementById('rowsToModify').value||'1',10);
  const sel=lastSel||hot.getSelectedLast(); if(!sel)return; const w=weekIndexForRow(sel[0]); if(w<0)return;
  const key=monthKey(current.getFullYear(),current.getMonth()); const start=weekStarts()[w]+1;
  bodyRows[w]+=n; monthStore[key].bodyRows=bodyRows.slice();
  monthStore[key].data.splice(start,0,...Array.from({length:n},()=>Array(TOTAL_COLS).fill("")));
  monthStore[key].meta=shiftMeta(monthStore[key].meta,start,n);
  renderMonth(); saveMonth(key);}
function delRows(){const n=parseInt(document.getElementById('rowsToModify').value||'1',10);
  const sel=lastSel||hot.getSelectedLast(); if(!sel)return; const w=weekIndexForRow(sel[0]); if(w<0)return;
  if(bodyRows[w]<=n)return; const key=monthKey(current.getFullYear(),current.getMonth()); const start=weekStarts()[w]+1;
  bodyRows[w]-=n; monthStore[key].bodyRows=bodyRows.slice();
  monthStore[key].data.splice(start,n);
  monthStore[key].meta=shiftMeta(monthStore[key].meta,start,-n);
  renderMonth(); saveMonth(key);}

/* ---------------- Directory ---------------- */
function getDirectoryMap(){
  const map={};
  if(!directoryHot) return map;
  directoryHot.getData().forEach(r=>{
    const name=(r[0]||"").trim().toLowerCase();
    const email=(r[1]||"").trim();
    if(name&&email)map[name]=email;
  });
  return map;
}

/* ---------------- Process Schedule ---------------- */
function parseSchedule(y, m) {
  const key = monthKey(y, m);
  const state = monthStore[key];
  if (!state) return;

  const data = state.data;
  const br = state.bodyRows;
  const calendar = state.calendar;

  function startsFrom(brArr) {
    const out = []; let acc = 0;
    for (let i = 0; i < brArr.length; i++) { out.push(acc); acc += 1 + brArr[i]; }
    return out;
  }
  const starts = startsFrom(br);
  function weekIndexForRowLocal(rowIdx) {
    for (let i = 0; i < br.length; i++) {
      if (rowIdx >= starts[i] && rowIdx <= starts[i] + br[i]) return i;
    }
    return -1;
  }
  function formatDate(d) {
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  }

  const shiftLog = [];
  const summaryShifts = {};
  const studyVisits = {};
  const siteVisits = {};
  const emailMap = getDirectoryMap();

  for (let c = 0; c < TOTAL_COLS; c += 2) {
    let r = 0;
    const maxRow = data.length;

    while (r < maxRow) {
      const study = (data[r][c] || "").trim();
      const visit = (data[r][c + 1] || "").trim();

      // Skip Travel/Stay/Drive rows
      const forbidden = ["TRAVEL","TRAVEL AM","TRAVEL PM","STAY","DRIVE"];
      if (forbidden.includes(study.toUpperCase())) { r++; continue; }

      if (study && visit) {
        const wk = weekIndexForRowLocal(r);
        const dayIdx = Math.floor(c / 2);
        let dateStr = `${y}-${m + 1}`;
        let dateObj = null;
        if (wk >= 0 && calendar && calendar[wk] && calendar[wk][dayIdx]) {
          dateObj = calendar[wk][dayIdx].date;
          dateStr = formatDate(dateObj);
        }

        let rr = r + 1;
        let pi = "";
        let site = "";
        const roles = [];

        while (rr < maxRow) {
          const left = (data[rr][c] || "").trim();
          const right = (data[rr][c + 1] || "").trim();
          const leftU = left.toUpperCase();

          if (!left && !right) { rr++; continue; }
          if (leftU === "INV") { pi = right; rr++; continue; }
          if (left === "Site") { site = right; rr++; break; }

          if (right && !["INV","SITE","TRAVEL","TRAVEL AM","TRAVEL PM","STAY","DRIVE"].includes(leftU)) {
            roles.push({ role: left, emp: right });
          }
          rr++;
        }

        roles.forEach(({ role, emp }) => {
          const email = emailMap[emp.toLowerCase()] || "";
          shiftLog.push([dateStr, study, visit, role, emp, email, site, pi]);
          summaryShifts[emp] = (summaryShifts[emp] || 0) + 1;
        });

        if (dateObj) {
          const dKey = formatDate(dateObj);
          if (!studyVisits[study]) studyVisits[study] = {};
          if (!studyVisits[study][dKey]) studyVisits[study][dKey] = new Set();
          if (site) studyVisits[study][dKey].add(site);
          if (site) {
            if (!siteVisits[site]) siteVisits[site] = new Set();
            siteVisits[site].add(dKey);
          }
        }

        r = rr; continue;
      }
      r++;
    }
  }

  state.shiftLog = shiftLog;
  state.summary = Object.entries(summaryShifts);
  state.summaryStudy = Object.entries(studyVisits).map(([study, dates]) => {
    let total = 0; Object.values(dates).forEach(set => total += set.size); return [study, total];
  });
  state.summarySite = Object.entries(siteVisits).map(([site, dates]) => [site, dates.size]);
}

/* ---------------- Reports ---------------- */
function refreshMonthSelect(){
  const sel=document.getElementById('monthSelect');
  sel.innerHTML="";
  Object.keys(monthStore).sort().forEach(k=>{
    const o=document.createElement('option');
    o.value=k; o.textContent=k; sel.appendChild(o);
  });
}
function renderReports(){
  const sel=document.getElementById('monthSelect').value;
  if(!sel) return;
  const [y,m]=sel.split('-').map(Number);
  parseSchedule(y, m-1);
  const s=monthStore[sel];

  renderTable("shiftLog", ["Date","Study","Visit","Role","Employee","Email","Site","PI"], s.shiftLog);
  renderTable("summary", ["Employee","Count"], s.summary);
  renderTable("summaryStudy", ["Study","Unique Visits"], s.summaryStudy);
  renderTable("summarySite", ["Site","Unique Visits"], s.summarySite);

  // Persist reports too
  saveMonth(sel);
}
function renderTable(id,hdrs,rows){
  let html = "<table class='out'><tr>" + hdrs.map(h=>`<th>${h}</th>`).join("") + "</tr>";
  rows.forEach(r=>{
    html += "<tr>" + r.map(v=>`<td>${v??""}</td>`).join("") + "</tr>";
  });
  html += "</table>";
  document.getElementById(id).innerHTML = html;
}

/* ---------------- Firestore save/load ---------------- */
async function saveMonth(key){
  const state=monthStore[key];
  if(!state) return;

  // Keep reports in sync
  const [yy,mm] = key.split('-').map(Number);
  parseSchedule(yy, mm-1);

  const payload = {
    dataRows: toRowMap(state.data),
    bodyRows: state.bodyRows || [],
    meta: state.meta || {},
    ...serializeReports(state)
  };

  try{
    await setDoc(doc(db, "months", key), payload, { merge:true });
  }catch(e){
    console.error("[saveMonth] error", e);
  }
}
function attachMonthListener(key){
  if(unsubscribeMonth){ unsubscribeMonth(); unsubscribeMonth=null; }
  unsubscribeMonth = onSnapshot(doc(db, "months", key), (snap)=>{
    if(!snap.exists()) return;
    const d = snap.data() || {};
    if(!monthStore[key]) monthStore[key]={};

    // restore grid/meta/bodyRows
    monthStore[key].data = fromRowMap(d.dataRows);
    monthStore[key].bodyRows = d.bodyRows || monthStore[key].bodyRows || [];
    monthStore[key].meta = d.meta || monthStore[key].meta || {};

    // restore reports
    const rep = deserializeReports(d);
    monthStore[key].shiftLog = rep.shiftLog;
    monthStore[key].summary = rep.summary;
    monthStore[key].summaryStudy = rep.summaryStudy;
    monthStore[key].summarySite = rep.summarySite;

    // ensure calendar for current month view
    const [yy,mm] = key.split('-').map(Number);
    monthStore[key].calendar = buildWeekMatrix(yy, mm-1, numWeeks(yy, mm-1));

    bodyRows = monthStore[key].bodyRows.slice();

    if(hot){
      hot.loadData(monthStore[key].data);
      hot.render();
    }
  });
}

/* ---------------- Expose functions for inline onclick ---------------- */
window.prevMonth = ()=>prevMonth();
window.nextMonth = ()=>nextMonth();
window.addRows  = ()=>addRows();
window.delRows  = ()=>delRows();
window.showPage = (id)=>showPage(id);
window.renderReports = ()=>renderReports();

/* ---------------- Init ---------------- */
renderMonth();
</script>
</body>
</html>
