<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Scheduler App</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.css">
<script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 18px; }
  nav { margin-bottom: 12px; }
  nav button { margin-right: 8px; }
  .page { display: none; }
  .page.active { display: block; }
  .palette { display:flex; gap:6px; flex-wrap:wrap; margin:8px 0; }
  .swatch { width:22px; height:22px; border:1px solid #999; border-radius:4px; cursor:pointer; }
  .swatch.clear { display:flex; align-items:center; justify-content:center; font-size:14px; }
  .handsontable th { background:#eee !important; }
  td.day-sep { border-right: 1px solid #aaa !important; }
  table.out { border-collapse: collapse; width:100%; margin-top:10px; }
  table.out th, table.out td { border:1px solid #ccc; padding:6px; font-size:12px; }
  table.out th { background:#eee; }
</style>
</head>
<body>
  <h1>Scheduler App</h1>
  <nav>
    <button onclick="showPage('schedulerPage')">Scheduler</button>
    <button onclick="showPage('directoryPage')">Directory</button>
    <button onclick="showPage('reportsPage')">Reports</button>
  </nav>

  <!-- Scheduler Page -->
  <div id="schedulerPage" class="page active">
    <h2>Monthly Scheduler</h2>
    <div class="toolbar">
      <button onclick="prevMonth()">◀ Prev</button>
      <span id="monthLabel"></span>
      <button onclick="nextMonth()">Next ▶</button>
      <span style="margin-left:12px;"><b>Fill color:</b></span>
      <div class="palette" id="palette"></div>
      <span style="margin-left:12px;"><b>Rows:</b></span>
      <input id="rowsToModify" type="number" min="1" value="1" style="width:60px;">
      <button onclick="addRows()">+ Add</button>
      <button onclick="delRows()">– Delete</button>
    </div>
    <div id="grid"></div>
  </div>

  <!-- Directory Page -->
  <div id="directoryPage" class="page">
    <h2>Email Directory</h2>
    <div id="directory"></div>
  </div>

  <!-- Reports Page -->
  <div id="reportsPage" class="page">
    <h2>Reports</h2>
    <label>Choose Month: 
      <select id="monthSelect"></select>
    </label>
    <button onclick="renderReports()">Generate Report</button>
    <h3>ShiftLog</h3>
    <div id="shiftLog"></div>
    <h3>Employee Summary</h3>
    <div id="summary"></div>
    <h3>Study Visits</h3>
    <div id="summaryStudy"></div>
    <h3>Site Visits</h3>
    <div id="summarySite"></div>
  </div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCfwfn-7WFnKNv-rdomdHxWU11WMIk7-NQ",
  authDomain: "crcscheduler.firebaseapp.com",
  projectId: "crcscheduler",
  storageBucket: "crcscheduler.firebasestorage.app",
  messagingSenderId: "865356677041",
  appId: "1:865356677041:web:002d88c85f00140088c790",
  measurementId: "G-00XV2C5HDL"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
signInAnonymously(getAuth(app)).then(()=>console.log("[auth] signed in")).catch(console.error);

window.firebaseBits = { db, doc, setDoc, onSnapshot };
</script>

<script>
/* ---------------- Shared State ---------------- */
let monthStore={}, current=new Date(), hot, directoryHot;
let lastSel=null, clipboardMeta=null;
const COLS_PER_DAY=2, DAYS_PER_WEEK=7, TOTAL_COLS=DAYS_PER_WEEK*COLS_PER_DAY;
let bodyRows=[];
let unwatchMonth=null;

const { db, doc, setDoc, onSnapshot } = window.firebaseBits;

/* Flatten/unflatten helpers for Firestore */
function flatten2D(arr){ return arr.map((row,i)=>({row:i, values: row.slice()})); }
function unflatten2D(objs){ return (objs||[]).map(o=>o.values); }

/* ---------------- Page Switching ---------------- */
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='reportsPage') refreshMonthSelect();
}
function monthKey(y,m){ return `${y}-${String(m+1).padStart(2,'0')}`; }

/* ---------------- Calendar Helpers ---------------- */
function startOfCalendar(year, monthIdx){
  const first=new Date(year,monthIdx,1);
  const dow=(first.getDay()+6)%7; // Mon=0
  const d=new Date(first);
  d.setDate(first.getDate()-dow);
  return d;
}
function numWeeks(year, monthIdx){
  const start=startOfCalendar(year,monthIdx);
  const end=new Date(year,monthIdx+1,0);
  const diff=Math.ceil((end-start)/86400000)+1;
  return Math.ceil(diff/7);
}
function buildWeekMatrix(year, monthIdx, weeks){
  const start=startOfCalendar(year,monthIdx);
  const matrix=[];
  for(let w=0;w<weeks;w++){
    const row=[];
    for(let d=0;d<DAYS_PER_WEEK;d++){
      const cell=new Date(start);
      cell.setDate(start.getDate()+w*7+d);
      row.push({
        date: new Date(cell),
        inMonth: cell.getMonth()===monthIdx
      });
    }
    matrix.push(row);
  }
  return matrix;
}

/* ---------------- Data ---------------- */
function buildDataFor(y,m,weeks,br){
  const rows=br.reduce((s,b)=>s+1+b,0);
  return Array.from({length:rows},()=>Array(TOTAL_COLS).fill(""));
}

/* ---------------- Renderer ---------------- */
function colorRenderer(instance, td, row, col, prop, value, cellProps){
  Handsontable.renderers.TextRenderer.apply(this, arguments);

  const key=monthKey(current.getFullYear(),current.getMonth());
  const color=monthStore[key]?.meta?.[`${row}:${col}`];
  if(color) td.style.background=color;

  const state = monthStore[key];
  if (state && state.calendar) {
    const weekIdx = weekIndexForRow(row);
    const dayIdx = Math.floor(col / 2);
    if (weekIdx >= 0 && state.calendar[weekIdx] && !state.calendar[weekIdx][dayIdx].inMonth) {
      td.style.background = "#f0f0f0";
      td.style.color = "#999";
    }
  }

  if(weekStarts().includes(row)){
    td.style.background="#e0e0e0";
    td.style.fontWeight="600";
  }
  if(col%2===1) td.classList.add('day-sep');
}

/* ---------------- Scheduler ---------------- */
function weekStarts(){let starts=[],acc=0;for(let i=0;i<bodyRows.length;i++){starts.push(acc);acc+=1+bodyRows[i];}return starts;}
function weekIndexForRow(rowIdx){const starts=weekStarts();for(let i=0;i<bodyRows.length;i++){if(rowIdx>=starts[i]&&rowIdx<=starts[i]+bodyRows[i])return i;}return -1;}

async function renderMonth(){
  const y=current.getFullYear(), m=current.getMonth(), key=monthKey(y,m);
  const weeks=numWeeks(y,m);
  if(!monthStore[key]){
    const br=Array(weeks).fill(8);
    const data=buildDataFor(y,m,weeks,br);
    const matrix=buildWeekMatrix(y,m,weeks);
    const dayMeta={};
    let acc=0;
    for(let w=0;w<weeks;w++){
      for(let d=0;d<DAYS_PER_WEEK;d++){
        const c=d*COLS_PER_DAY;
        data[acc][c]=matrix[w][d].date.toLocaleString('default',{weekday:'short'})+" "+matrix[w][d].date.getDate();
        dayMeta[`${acc}:${c}`]=matrix[w][d];
      }
      acc+=1+br[w];
    }
    monthStore[key]={data,bodyRows:br,meta:{},dayMeta,calendar:matrix,shiftLog:[],summary:[],summaryStudy:[],summarySite:[]};
    await saveMonth(key);
  }
  bodyRows=monthStore[key].bodyRows.slice();
  document.getElementById("monthLabel").textContent=current.toLocaleString('default',{month:'long'})+" "+y;
  if(hot) hot.destroy();
  hot=new Handsontable(document.getElementById('grid'),{
    data:monthStore[key].data,
    colHeaders:false,rowHeaders:true,
    columns:Array.from({length:TOTAL_COLS},()=>({type:'text'})),
    licenseKey:'non-commercial-and-evaluation',
    contextMenu:true,
    cells:(r,c)=>{let props={renderer:colorRenderer}; if(weekStarts().includes(r)) props.readOnly=true; return props;},
    afterSelectionEnd:(r1,c1,r2,c2)=>{lastSel=[r1,c1,r2,c2];},
    afterChange:(ch,src)=>{ if(src!=="loadData") saveMonth(key); }
  });
  attachMonthListener(key);
}
function prevMonth(){ current.setMonth(current.getMonth()-1); renderMonth(); }
function nextMonth(){ current.setMonth(current.getMonth()+1); renderMonth(); }

/* ---------------- Firebase Save/Load ---------------- */
async function saveMonth(key){
  try {
    const state=monthStore[key];
    if(!state) return;
    const cleanData = flatten2D(state.data);
    const calendar=(state.calendar||[]).map(w=>w.map(d=>({date:d.date.toISOString(),inMonth:d.inMonth})));
    await setDoc(doc(db,"months",key),{
      data:cleanData,
      meta:state.meta||{},
      bodyRows:state.bodyRows||[],
      calendar
    },{merge:true});
  } catch(e){ console.error("[saveMonth] error",e); }
}
function attachMonthListener(key){
  if(unwatchMonth){unwatchMonth(); unwatchMonth=null;}
  unwatchMonth=onSnapshot(doc(db,"months",key),(snap)=>{
    if(!snap.exists()) return;
    const s=snap.data();
    const rows = unflatten2D(s.data||[]);
    const calendar=(s.calendar||[]).map(w=>w.map(d=>({date:new Date(d.date),inMonth:d.inMonth})));
    monthStore[key]={...monthStore[key],data:rows,meta:s.meta||{},bodyRows:s.bodyRows||[],calendar};
    bodyRows=monthStore[key].bodyRows.slice();
    if(hot){hot.loadData(monthStore[key].data);hot.render();}
  });
}

/* ---------------- Colors ---------------- */
const colors=["#f28b82","#fbbc04","#fff475","#ccff90","#a7ffeb","#cbf0f8","#aecbfa","#d7aefb","#fdcfe8","#e6c9a8","#e8eaed","#d50000","#c51162","#aa00ff","#304ffe","#2962ff","#0091ea","#00b8d4","#00c853","#64dd17"];
(function(){const p=document.getElementById('palette');colors.forEach(c=>{let sw=document.createElement('div');sw.className='swatch';sw.style.background=c;sw.onclick=()=>applyColor(c);p.appendChild(sw);});let clr=document.createElement('div');clr.className='swatch clear';clr.textContent='×';clr.onclick=()=>applyColor(null);p.appendChild(clr);})();
function applyColor(color){
  const sel=lastSel||hot.getSelectedLast(); if(!sel)return;
  const [r1,c1,r2,c2]=sel; const key=monthKey(current.getFullYear(),current.getMonth());
  if(!monthStore[key].meta) monthStore[key].meta={};
  for(let r=Math.min(r1,r2);r<=Math.max(r1,r2);r++){ if(weekStarts().includes(r))continue;
    for(let c=Math.min(c1,c2);c<=Math.max(c1,c2);c++){
      if(color) monthStore[key].meta[`${r}:${c}`]=color; else delete monthStore[key].meta[`${r}:${c}`];
    }}
  hot.render(); saveMonth(key);
}

/* ---------------- Add/Delete Rows ---------------- */
function shiftMeta(meta, startRow, delta){
  const newMeta={};
  Object.entries(meta).forEach(([k,v])=>{
    let [r,c]=k.split(":").map(Number);
    if(r>=startRow) r+=delta;
    newMeta[`${r}:${c}`]=v;
  });
  return newMeta;
}
function addRows(){const n=parseInt(document.getElementById('rowsToModify').value||'1',10);
  const sel=lastSel||hot.getSelectedLast(); if(!sel)return; const w=weekIndexForRow(sel[0]); if(w<0)return;
  const key=monthKey(current.getFullYear(),current.getMonth()); const start=weekStarts()[w]+1;
  bodyRows[w]+=n; monthStore[key].bodyRows=bodyRows.slice();
  monthStore[key].data.splice(start,0,...Array.from({length:n},()=>Array(TOTAL_COLS).fill("")));
  monthStore[key].meta=shiftMeta(monthStore[key].meta,start,n);
  renderMonth(); saveMonth(key);}
function delRows(){const n=parseInt(document.getElementById('rowsToModify').value||'1',10);
  const sel=lastSel||hot.getSelectedLast(); if(!sel)return; const w=weekIndexForRow(sel[0]); if(w<0)return;
  if(bodyRows[w]<=n)return; const key=monthKey(current.getFullYear(),current.getMonth()); const start=weekStarts()[w]+1;
  bodyRows[w]-=n; monthStore[key].bodyRows=bodyRows.slice();
  monthStore[key].data.splice(start,n);
  monthStore[key].meta=shiftMeta(monthStore[key].meta,start,-n);
  renderMonth(); saveMonth(key);}

/* ---------------- Directory ---------------- */
directoryHot=new Handsontable(document.getElementById('directory'),{
  data:[["","",""]],
  colHeaders:["Name","Email","Phone"], rowHeaders:true, minSpareRows:1,
  contextMenu:true, licenseKey:'non-commercial-and-evaluation'
});
function getDirectoryMap(){const map={};directoryHot.getData().forEach(r=>{const name=(r[0]||"").trim().toLowerCase();const email=(r[1]||"").trim();if(name&&email)map[name]=email;});return map;}

/* ---------------- Process Schedule ---------------- */
function parseSchedule(y, m) {
  const key = monthKey(y, m);
  const state = monthStore[key];
  if (!state) return;

  const data = state.data;
  const br = state.bodyRows;
  const calendar = state.calendar;

  function startsFrom(brArr) {
    const out = []; let acc = 0;
    for (let i = 0; i < brArr.length; i++) { out.push(acc); acc += 1 + brArr[i]; }
    return out;
  }
  const starts = startsFrom(br);
  function weekIndexForRowLocal(rowIdx) {
    for (let i = 0; i < br.length; i++) {
      if (rowIdx >= starts[i] && rowIdx <= starts[i] + br[i]) return i;
    }
    return -1;
  }
  function formatDate(d) {
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  }

  const shiftLog = [];
  const summaryShifts = {};
  const studyVisits = {};
  const siteVisits = {};
  const emailMap = getDirectoryMap();

  for (let c = 0; c < TOTAL_COLS; c += 2) {
    let r = 0;
    const maxRow = data.length;

    while (r < maxRow) {
      const study = (data[r][c] || "").trim();
      const visit = (data[r][c + 1] || "").trim();

      const forbidden = ["TRAVEL","TRAVEL AM","TRAVEL PM","STAY","DRIVE"];
      if (forbidden.includes(study.toUpperCase())) { r++; continue; }

      if (study && visit) {
        const wk = weekIndexForRowLocal(r);
        const dayIdx = Math.floor(c / 2);
        let dateStr = `${y}-${m + 1}`;
        let dateObj = null;
        if (wk >= 0 && calendar && calendar[wk] && calendar[wk][dayIdx]) {
          dateObj = calendar[wk][dayIdx].date;
          dateStr = formatDate(dateObj);
        }

        let rr = r + 1;
        let pi = "";
        let site = "";
        const roles = [];

        while (rr < maxRow) {
          const left = (data[rr][c] || "").trim();
          const right = (data[rr][c + 1] || "").trim();
          const leftU = left.toUpperCase();

          if (!left && !right) { rr++; continue; }
          if (leftU === "INV") { pi = right; rr++; continue; }
          if (left === "Site") { site = right; rr++; break; }

          if (right && !["INV","SITE","TRAVEL","TRAVEL AM","TRAVEL PM","STAY","DRIVE"].includes(leftU)) {
            roles.push({ role: left, emp: right });
          }
          rr++;
        }

        // ShiftLog entries
        roles.forEach(({ role, emp }) => {
          const email = emailMap[emp.toLowerCase()] || "";
          shiftLog.push([dateStr, study, visit, role, emp, email, site, pi]);
          summaryShifts[emp] = (summaryShifts[emp] || 0) + 1;
        });

        // Unique visits counting (study/site by day)
        if (dateObj) {
          const dKey = formatDate(dateObj);

          if (!studyVisits[study]) studyVisits[study] = {};
          if (!studyVisits[study][dKey]) studyVisits[study][dKey] = new Set();
          if (site) studyVisits[study][dKey].add(site);

          if (site) {
            if (!siteVisits[site]) siteVisits[site] = new Set();
            siteVisits[site].add(dKey);
          }
        }

        r = rr;
        continue;
      }
      r++;
    }
  }

  state.shiftLog = shiftLog;
  state.summary = Object.entries(summaryShifts);

  state.summaryStudy = Object.entries(studyVisits).map(([study, dates]) => {
    let total = 0;
    Object.values(dates).forEach(set => total += set.size);
    return [study, total];
  });

  state.summarySite = Object.entries(siteVisits).map(([site, dates]) => [site, dates.size]);
}

/* ---------------- Reports ---------------- */
function refreshMonthSelect(){
  const sel=document.getElementById('monthSelect');
  sel.innerHTML="";
  Object.keys(monthStore).sort().forEach(k=>{
    const o=document.createElement('option');
    o.value=k; o.textContent=k; sel.appendChild(o);
  });
}

function renderReports(){
  const sel=document.getElementById('monthSelect').value;
  if(!sel) return;
  const [y,m]=sel.split('-').map(Number);
  parseSchedule(y, m-1);
  const s=monthStore[sel];

  renderTable("shiftLog",
    ["Date","Study","Visit","Role","Employee","Email","Site","PI"],
    s.shiftLog
  );
  renderTable("summary",
    ["Employee","Count"],
    s.summary
  );
  renderTable("summaryStudy",
    ["Study","Unique Visits"],
    s.summaryStudy
  );
  renderTable("summarySite",
    ["Site","Unique Visits"],
    s.summarySite
  );
}

function renderTable(id,hdrs,rows){
  let html = "<table class='out'><tr>" + hdrs.map(h=>`<th>${h}</th>`).join("") + "</tr>";
  rows.forEach(r=>{
    html += "<tr>" + r.map(v=>`<td>${v??""}</td>`).join("") + "</tr>";
  });
  html += "</table>";
  document.getElementById(id).innerHTML = html;
}

/* ---------------- Init ---------------- */
renderMonth();
</script>
</body>
</html>
