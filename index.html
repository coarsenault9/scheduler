<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Scheduler App</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.css">
<style>
  body { font-family: Arial, sans-serif; margin: 18px; }
  nav { margin-bottom: 12px; }
  nav button { margin-right: 8px; }
  .page { display: none; }
  .page.active { display: block; }
  .palette { display:flex; gap:6px; flex-wrap:wrap; margin:8px 0; }
  .swatch { width:22px; height:22px; border:1px solid #999; border-radius:4px; cursor:pointer; }
  .swatch.clear { display:flex; align-items:center; justify-content:center; font-size:14px; }
  .handsontable th { background:#eee !important; }
  td.day-sep { border-right: 1px solid #aaa !important; }
  table.out { border-collapse: collapse; width:100%; margin-top:10px; }
  table.out th, table.out td { border:1px solid #ccc; padding:6px; font-size:12px; }
  table.out th { background:#eee; }
</style>
</head>
<body>
  <h1>Scheduler App</h1>
  <nav>
    <button onclick="showPage('schedulerPage')">Scheduler</button>
    <button onclick="showPage('directoryPage')">Directory</button>
    <button onclick="showPage('reportsPage')">Reports</button>
  </nav>

  <!-- Scheduler Page -->
  <div id="schedulerPage" class="page active">
    <h2>Monthly Scheduler</h2>
    <div class="toolbar">
      <button onclick="prevMonth()">◀ Prev</button>
      <span id="monthLabel"></span>
      <button onclick="nextMonth()">Next ▶</button>
      <span style="margin-left:12px;"><b>Fill color:</b></span>
      <div class="palette" id="palette"></div>
      <span style="margin-left:12px;"><b>Rows:</b></span>
      <input id="rowsToModify" name="rowsToModify" type="number" min="1" value="1" style="width:60px;" autocomplete="off">
      <button onclick="addRows()">+ Add</button>
      <button onclick="delRows()">– Delete</button>
    </div>
    <div id="grid"></div>
  </div>

  <!-- Directory Page -->
  <div id="directoryPage" class="page">
    <h2>Email Directory</h2>
    <div id="directory"></div>
  </div>

  <!-- Reports Page -->
  <div id="reportsPage" class="page">
    <h2>Reports</h2>
    <label>Choose Month: 
      <select id="monthSelect"></select>
    </label>
    <button onclick="renderReports()">Generate Report</button>
    <h3>ShiftLog</h3>
    <div id="shiftLog"></div>
    <h3>Employee Summary</h3>
    <div id="summary"></div>
    <h3>Study Visits</h3>
    <div id="summaryStudy"></div>
    <h3>Site Visits</h3>
    <div id="summarySite"></div>
  </div>

<script type="module">
/* ========== Imports (ESM) ========== */
import Handsontable from "https://cdn.jsdelivr.net/npm/handsontable@14.3.0/esm/handsontable.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ========== Firebase Init (ESM) ========== */
const firebaseConfig = {
  apiKey: "AIzaSyCfwfn-7WFnKNv-rdomdHxWU11WMIk7-NQ",
  authDomain: "crcscheduler.firebaseapp.com",
  projectId: "crcscheduler",
  storageBucket: "crcscheduler.firebasestorage.app",
  messagingSenderId: "865356677041",
  appId: "1:865356677041:web:002d88c85f00140088c790",
  measurementId: "G-00XV2C5HDL"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth, (u) => { if (u) console.log("Firebase signed in:", u.uid); });

/* ========== State ========== */
let monthStore={}, current=new Date(), hot, directoryHot;
let lastSel=null, clipboardMeta=null;
const COLS_PER_DAY=2, DAYS_PER_WEEK=7, TOTAL_COLS=DAYS_PER_WEEK*COLS_PER_DAY;
let bodyRows=[];
let unsubscribeMonth = null;

/* ========== Firestore Helpers ========== */
function toRowMap(data){ const obj={}; for(let i=0;i<data.length;i++){ obj[i]=data[i].map(v=>v||""); } return obj; }
function fromRowMap(obj){ if(!obj) return []; const keys=Object.keys(obj).map(Number).sort((a,b)=>a-b); return keys.map(k=>obj[k]); }
function serializeReports(state){ const toShift=(rows)=>rows.map(r=>({date:r[0]||"",study:r[1]||"",visit:r[2]||"",role:r[3]||"",employee:r[4]||"",email:r[5]||"",site:r[6]||"",pi:r[7]||""})); const toKV=(rows)=>rows.map(r=>({k:r[0]||"",v:r[1]||0})); return {shiftLog:toShift(state.shiftLog||[]),summary:toKV(state.summary||[]),summaryStudy:toKV(state.summaryStudy||[]),summarySite:toKV(state.summarySite||[])}; }
function deserializeReports(d){ const fromShift=(arr)=>(arr||[]).map(o=>[o.date,o.study,o.visit,o.role,o.employee,o.email,o.site,o.pi]); const fromKV=(arr)=>(arr||[]).map(o=>[o.k,o.v]); return {shiftLog:fromShift(d.shiftLog),summary:fromKV(d.summary),summaryStudy:fromKV(d.summaryStudy),summarySite:fromKV(d.summarySite)}; }

/* ========== Calendar Helpers ========== */
function monthKey(y,m){ return `${y}-${String(m+1).padStart(2,'0')}`; }
function startOfCalendar(y,m){ const f=new Date(y,m,1); const dow=(f.getDay()+6)%7; const d=new Date(f); d.setDate(f.getDate()-dow); return d; }
function numWeeks(y,m){ const start=startOfCalendar(y,m); const end=new Date(y,m+1,0); const diff=Math.ceil((end-start)/86400000)+1; return Math.ceil(diff/7); }
function buildWeekMatrix(y,m,weeks){ const start=startOfCalendar(y,m); const matrix=[]; for(let w=0;w<weeks;w++){ const row=[]; for(let d=0;d<7;d++){ const cell=new Date(start); cell.setDate(start.getDate()+w*7+d); row.push({date:new Date(cell),inMonth:cell.getMonth()===m}); } matrix.push(row);} return matrix; }
function buildDataFor(y,m,weeks,br){ const rows=br.reduce((s,b)=>s+1+b,0); return Array.from({length:rows},()=>Array(TOTAL_COLS).fill("")); }

/* ========== Renderer ========== */
function colorRenderer(instance, td, row, col){ Handsontable.renderers.TextRenderer.apply(this, arguments); const key=monthKey(current.getFullYear(),current.getMonth()); const color=monthStore[key]?.meta?.[`${row}:${col}`]; if(color) td.style.background=color; }

/* ========== Scheduler ========== */
function weekStarts(){let starts=[],acc=0;for(let i=0;i<bodyRows.length;i++){starts.push(acc);acc+=1+bodyRows[i];}return starts;}
function renderMonth(){ const y=current.getFullYear(),m=current.getMonth(),key=monthKey(y,m); const weeks=numWeeks(y,m); if(!monthStore[key]){ const br=Array(weeks).fill(8); const data=buildDataFor(y,m,weeks,br); const matrix=buildWeekMatrix(y,m,weeks); let acc=0; for(let w=0;w<weeks;w++){ for(let d=0;d<7;d++){ const c=d*2; data[acc][c]=matrix[w][d].date.toLocaleString('default',{weekday:'short'})+" "+matrix[w][d].date.getDate(); } acc+=1+br[w]; } monthStore[key]={data,bodyRows:br,meta:{},calendar:matrix,shiftLog:[],summary:[],summaryStudy:[],summarySite:[]}; saveMonth(key);} attachMonthListener(key); bodyRows=monthStore[key].bodyRows.slice(); document.getElementById("monthLabel").textContent=current.toLocaleString('default',{month:'long'})+" "+y; if(hot) hot.destroy(); hot=new Handsontable(document.getElementById('grid'),{data:monthStore[key].data,columns:Array.from({length:TOTAL_COLS},()=>({type:'text'})),licenseKey:'non-commercial-and-evaluation',cells:(r)=>{let props={renderer:colorRenderer}; if(weekStarts().includes(r)) props.readOnly=true; return props;},afterChange:(c,s)=>{if(s!=='loadData') saveMonth(key);}}); if(!directoryHot){ directoryHot=new Handsontable(document.getElementById('directory'),{data:[["","",""]],colHeaders:["Name","Email","Phone"],rowHeaders:true,minSpareRows:1,contextMenu:true,licenseKey:'non-commercial-and-evaluation'});} }
function prevMonth(){ current.setMonth(current.getMonth()-1); renderMonth(); }
function nextMonth(){ current.setMonth(current.getMonth()+1); renderMonth(); }

/* ========== Colors ========== */
const colors=["#f28b82","#fbbc04","#fff475","#ccff90","#a7ffeb","#cbf0f8","#aecbfa","#d7aefb","#fdcfe8","#e6c9a8","#e8eaed"]; (function(){const p=document.getElementById('palette');colors.forEach(c=>{let sw=document.createElement('div');sw.className='swatch';sw.style.background=c;sw.onclick=()=>applyColor(c);p.appendChild(sw);});let clr=document.createElement('div');clr.className='swatch clear';clr.textContent='×';clr.onclick=()=>applyColor(null);p.appendChild(clr);})(); function applyColor(color){const sel=hot.getSelectedLast();if(!sel)return;const [r1,c1,r2,c2]=sel;const key=monthKey(current.getFullYear(),current.getMonth());if(!monthStore[key].meta) monthStore[key].meta={};for(let r=Math.min(r1,r2);r<=Math.max(r1,r2);r++){for(let c=Math.min(c1,c2);c<=Math.max(c1,c2);c++){if(color) monthStore[key].meta[`${r}:${c}`]=color;else delete monthStore[key].meta[`${r}:${c}`];}}hot.render();saveMonth(key);} 

/* ========== Directory Map ========== */
function getDirectoryMap(){const map={};directoryHot.getData().forEach(r=>{const name=(r[0]||"").trim().toLowerCase();const email=(r[1]||"").trim();if(name&&email)map[name]=email;});return map;}

/* ========== Parse Schedule ========== */
function parseSchedule(y,m){ const key=monthKey(y,m); const state=monthStore[key]; if(!state) return; const data=state.data; const calendar=state.calendar; const shiftLog=[]; const summaryShifts={}; const studyVisits={}; const siteVisits={}; const emailMap=getDirectoryMap(); for(let c=0;c<TOTAL_COLS;c+=2){ let r=0; while(r<data.length){ const study=(data[r][c]||"").trim(); const visit=(data[r][c+1]||"").trim(); if(study && visit && !["TRAVEL","STAY","DRIVE"].includes(study.toUpperCase())){ const dayIdx=Math.floor(c/2); const dateObj=calendar[Math.floor(r/(state.bodyRows[0]+1))]?.[dayIdx]?.date; const dateStr=dateObj?dateObj.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}):""; let rr=r+1,pi="",site="",roles=[]; while(rr<data.length){const left=(data[rr][c]||"").trim(),right=(data[rr][c+1]||"").trim(); if(left.toUpperCase()==="INV"){pi=right;rr++;continue;} if(left==="Site"){site=right;rr++;break;} if(right) roles.push({role:left,emp:right}); rr++;} roles.forEach(({role,emp})=>{const email=emailMap[emp.toLowerCase()]||""; shiftLog.push([dateStr,study,visit,role,emp,email,site,pi]); summaryShifts[emp]=(summaryShifts[emp]||0)+1;}); if(dateObj){const dKey=dateStr; if(!studyVisits[study]) studyVisits[study]={}; studyVisits[study][dKey]=(studyVisits[study][dKey]||new Set()).add(site); siteVisits[site]=(siteVisits[site]||new Set()).add(dKey);} r=rr; continue;} r++; }} state.shiftLog=shiftLog; state.summary=Object.entries(summaryShifts); state.summaryStudy=Object.entries(studyVisits).map(([s,dates])=>[s,Object.values(dates).reduce((a,b)=>a+b.size,0)]); state.summarySite=Object.entries(siteVisits).map(([site,dates])=>[site,dates.size]); }

/* ========== Reports ========== */
function refreshMonthSelect(){const sel=document.getElementById('monthSelect');sel.innerHTML="";Object.keys(monthStore).sort().forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k;sel.appendChild(o);});}
function renderReports(){const sel=document.getElementById('monthSelect').value;if(!sel)return;const [y,m]=sel.split('-').map(Number);parseSchedule(y,m-1);const s=monthStore[sel];renderTable("shiftLog",["Date","Study","Visit","Role","Employee","Email","Site","PI"],s.shiftLog);renderTable("summary",["Employee","Count"],s.summary);renderTable("summaryStudy",["Study","Unique Visits"],s.summaryStudy);renderTable("summarySite",["Site","Unique Visits"],s.summarySite);saveMonth(sel);}
function renderTable(id,hdrs,rows){let html="<table class='out'><tr>"+hdrs.map(h=>`<th>${h}</th>`).join("")+"</tr>";rows.forEach(r=>{html+="<tr>"+r.map(v=>`<td>${v??""}</td>`).join("")+"</tr>";});html+="</table>";document.getElementById(id).innerHTML=html;}

/* ========== Firestore Sync ========== */
async function saveMonth(key){const state=monthStore[key];if(!state)return;const [yy,mm]=key.split('-').map(Number);parseSchedule(yy,mm-1);const payload={dataRows:toRowMap(state.data),bodyRows:state.bodyRows,meta:state.meta,...serializeReports(state)};await setDoc(doc(db,"months",key),payload,{merge:true});}
function attachMonthListener(key){if(unsubscribeMonth){unsubscribeMonth();unsubscribeMonth=null;}unsubscribeMonth=onSnapshot(doc(db,"months",key),(snap)=>{if(!snap.exists())return;const d=snap.data()||{};if(!monthStore[key])monthStore[key]={};monthStore[key].data=fromRowMap(d.dataRows);monthStore[key].bodyRows=d.bodyRows||[];monthStore[key].meta=d.meta||{};const rep=deserializeReports(d);monthStore[key].shiftLog=rep.shiftLog;monthStore[key].summary=rep.summary;monthStore[key].summaryStudy=rep.summaryStudy;monthStore[key].summarySite=rep.summarySite;if(hot){hot.loadData(monthStore[key].data);hot.render();}});}

/* ========== Expose ========== */
window.prevMonth=prevMonth;window.nextMonth=nextMonth;window.showPage=(id)=>{document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active');};window.addRows=()=>{};window.delRows=()=>{};window.renderReports=renderReports;

/* ========== Init ========== */
renderMonth();
</script>
</body>
</html>
